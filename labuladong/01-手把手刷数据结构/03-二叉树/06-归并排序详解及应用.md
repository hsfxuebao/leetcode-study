# å½’å¹¶æ’åºè¯¦è§£åŠåº”ç”¨

è¯»å®Œæœ¬æ–‡ï¼Œä½ ä¸ä»…å­¦ä¼šäº†ç®—æ³•å¥—è·¯ï¼Œè¿˜å¯ä»¥é¡ºä¾¿è§£å†³å¦‚ä¸‹é¢˜ç›®ï¼š

|                           LeetCode                           |                             åŠ›æ‰£                             | éš¾åº¦ |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :--: |
| [315. Count of Smaller Numbers After Self](https://leetcode.com/problems/count-of-smaller-numbers-after-self/) | [315. è®¡ç®—å³ä¾§å°äºå½“å‰å…ƒç´ çš„ä¸ªæ•°](https://leetcode.cn/problems/count-of-smaller-numbers-after-self/) |  ğŸ”´   |
| [327. Count of Range Sum](https://leetcode.com/problems/count-of-range-sum/) | [327. åŒºé—´å’Œçš„ä¸ªæ•°](https://leetcode.cn/problems/count-of-range-sum/) |  ğŸ”´   |
| [493. Reverse Pairs](https://leetcode.com/problems/reverse-pairs/) |  [493. ç¿»è½¬å¯¹](https://leetcode.cn/problems/reverse-pairs/)  |  ğŸ”´   |
| [912. Sort an Array](https://leetcode.com/problems/sort-an-array/) | [912. æ’åºæ•°ç»„](https://leetcode.cn/problems/sort-an-array/) |  ğŸŸ    |

**â€”â€”â€”â€“**

ä¸€ç›´éƒ½æœ‰å¾ˆå¤šè¯»è€…è¯´ï¼Œæƒ³è®©æˆ‘ç”¨ [æ¡†æ¶æ€ç»´](https://labuladong.github.io/algo/1/2/) è®²ä¸€è®²åŸºæœ¬çš„æ’åºç®—æ³•ï¼Œæˆ‘è§‰å¾—ç¡®å®å¾—è®²è®²ï¼Œæ¯•ç«Ÿå­¦ä¹ ä»»ä½•ä¸œè¥¿éƒ½è®²æ±‚ä¸€ä¸ªèä¼šè´¯é€šï¼Œåªæœ‰å¯¹å…¶æœ¬è´¨è¿›è¡Œæ¯”è¾ƒæ·±åˆ»çš„ç†è§£ï¼Œæ‰èƒ½è¿ç”¨è‡ªå¦‚ã€‚

æœ¬æ–‡å°±å…ˆè®²å½’å¹¶æ’åºï¼Œç»™ä¸€å¥—ä»£ç æ¨¡æ¿ï¼Œç„¶åè®²è®²å®ƒåœ¨ç®—æ³•é—®é¢˜ä¸­çš„åº”ç”¨ã€‚é˜…è¯»æœ¬æ–‡å‰æˆ‘å¸Œæœ›ä½ è¯»è¿‡å‰æ–‡ [æ‰‹æŠŠæ‰‹åˆ·äºŒå‰æ ‘ï¼ˆçº²é¢†ç¯‡ï¼‰](https://labuladong.github.io/algo/2/21/36/)ã€‚

æˆ‘åœ¨ [æ‰‹æŠŠæ‰‹åˆ·äºŒå‰æ ‘ï¼ˆç¬¬ä¸€æœŸï¼‰](https://labuladong.github.io/algo/2/21/37/) è®²äºŒå‰æ ‘çš„æ—¶å€™ï¼Œæäº†ä¸€å˜´å½’å¹¶æ’åºï¼Œè¯´å½’å¹¶æ’åºå°±æ˜¯äºŒå‰æ ‘çš„ååºéå†ï¼Œå½“æ—¶å°±æœ‰å¾ˆå¤šè¯»è€…ç•™è¨€è¯´é†é†çŒé¡¶ã€‚

çŸ¥é“ä¸ºä»€ä¹ˆå¾ˆå¤šè¯»è€…é‡åˆ°é€’å½’ç›¸å…³çš„ç®—æ³•å°±è§‰å¾—çƒ§è„‘å—ï¼Ÿå› ä¸ºè¿˜å¤„åœ¨ã€Œçœ‹å±±æ˜¯å±±ï¼Œçœ‹æ°´æ˜¯æ°´ã€çš„é˜¶æ®µã€‚

å°±è¯´å½’å¹¶æ’åºå§ï¼Œå¦‚æœç»™ä½ çœ‹ä»£ç ï¼Œè®©ä½ è„‘è¡¥ä¸€ä¸‹å½’å¹¶æ’åºçš„è¿‡ç¨‹ï¼Œä½ è„‘å­é‡Œä¼šå‡ºç°ä»€ä¹ˆåœºæ™¯ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªæ•°ç»„æ’åºç®—æ³•ï¼Œæ‰€ä»¥ä½ è„‘è¡¥ä¸€ä¸ªæ•°ç»„çš„ GIFï¼Œåœ¨é‚£ä¸€ä¸ªä¸ªäº¤æ¢å…ƒç´ ï¼Ÿå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œé‚£æ ¼å±€å°±ä½äº†ã€‚

ä½†å¦‚æœä½ è„‘æµ·ä¸­æµ®ç°å‡ºçš„æ˜¯ä¸€æ£µäºŒå‰æ ‘ï¼Œç”šè‡³æµ®ç°å‡ºäºŒå‰æ ‘ååºéå†çš„åœºæ™¯ï¼Œé‚£æ ¼å±€å°±é«˜äº†ï¼Œå¤§æ¦‚ç‡æŒæ¡äº†æˆ‘ç»å¸¸å¼ºè°ƒçš„ [æ¡†æ¶æ€ç»´](https://labuladong.github.io/algo/1/2/)ï¼Œç”¨è¿™ç§æŠ½è±¡èƒ½åŠ›å­¦ä¹ ç®—æ³•å°±çœåŠ²å¤šäº†ã€‚

é‚£ä¹ˆï¼Œå½’å¹¶æ’åºæ˜æ˜å°±æ˜¯ä¸€ä¸ªæ•°ç»„ç®—æ³•ï¼Œå’ŒäºŒå‰æ ‘æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿæ¥ä¸‹æ¥æˆ‘å°±å…·ä½“è®²è®²ã€‚

### ç®—æ³•æ€è·¯

**å°±è¿™ä¹ˆè¯´å§ï¼Œæ‰€æœ‰é€’å½’çš„ç®—æ³•ï¼Œä½ ç”­ç®¡å®ƒæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨éå†ä¸€æ£µï¼ˆé€’å½’ï¼‰æ ‘ï¼Œç„¶ååœ¨èŠ‚ç‚¹ï¼ˆå‰ä¸­ååºä½ç½®ï¼‰ä¸Šæ‰§è¡Œä»£ç ï¼Œä½ è¦å†™é€’å½’ç®—æ³•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è¦å‘Šè¯‰æ¯ä¸ªèŠ‚ç‚¹éœ€è¦åšä»€ä¹ˆ**ã€‚

ä½ çœ‹å½’å¹¶æ’åºçš„ä»£ç æ¡†æ¶ï¼š

```java
// å®šä¹‰ï¼šæ’åº nums[lo..hi]
void sort(int[] nums, int lo, int hi) {
    if (lo == hi) {
        return;
    }
    int mid = (lo + hi) / 2;
    // åˆ©ç”¨å®šä¹‰ï¼Œæ’åº nums[lo..mid]
    sort(nums, lo, mid);
    // åˆ©ç”¨å®šä¹‰ï¼Œæ’åº nums[mid+1..hi]
    sort(nums, mid + 1, hi);

    /****** ååºä½ç½® ******/
    // æ­¤æ—¶ä¸¤éƒ¨åˆ†å­æ•°ç»„å·²ç»è¢«æ’å¥½åº
    // åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„ï¼Œä½¿ nums[lo..hi] æœ‰åº
    merge(nums, lo, mid, hi);
    /*********************/
}

// å°†æœ‰åºæ•°ç»„ nums[lo..mid] å’Œæœ‰åºæ•°ç»„ nums[mid+1..hi]
// åˆå¹¶ä¸ºæœ‰åºæ•°ç»„ nums[lo..hi]
void merge(int[] nums, int lo, int mid, int hi);
```

çœ‹è¿™ä¸ªæ¡†æ¶ï¼Œä¹Ÿå°±æ˜ç™½é‚£å¥ç»å…¸çš„æ€»ç»“ï¼šå½’å¹¶æ’åºå°±æ˜¯å…ˆæŠŠå·¦åŠè¾¹æ•°ç»„æ’å¥½åºï¼Œå†æŠŠå³åŠè¾¹æ•°ç»„æ’å¥½åºï¼Œç„¶åæŠŠä¸¤åŠæ•°ç»„åˆå¹¶ã€‚

ä¸Šè¿°ä»£ç å’ŒäºŒå‰æ ‘çš„ååºéå†å¾ˆåƒï¼š

```java
/* äºŒå‰æ ‘éå†æ¡†æ¶ */
void traverse(TreeNode root) {
    if (root == null) {
        return;
    }
    traverse(root.left);
    traverse(root.right);
    /****** ååºä½ç½® ******/
    print(root.val);
    /*********************/
}
```

å†è¿›ä¸€æ­¥ï¼Œä½ è”æƒ³ä¸€ä¸‹æ±‚äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦çš„ç®—æ³•ä»£ç ï¼š

```java
// å®šä¹‰ï¼šè¾“å…¥æ ¹èŠ‚ç‚¹ï¼Œè¿”å›è¿™æ£µäºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦
int maxDepth(TreeNode root) {
	if (root == null) {
		return 0;
	}
	// åˆ©ç”¨å®šä¹‰ï¼Œè®¡ç®—å·¦å³å­æ ‘çš„æœ€å¤§æ·±åº¦
	int leftMax = maxDepth(root.left);
	int rightMax = maxDepth(root.right);
	// æ•´æ£µæ ‘çš„æœ€å¤§æ·±åº¦ç­‰äºå·¦å³å­æ ‘çš„æœ€å¤§æ·±åº¦å–æœ€å¤§å€¼ï¼Œ
    // ç„¶åå†åŠ ä¸Šæ ¹èŠ‚ç‚¹è‡ªå·±
	int res = Math.max(leftMax, rightMax) + 1;

	return res;
}
```

æ˜¯ä¸æ˜¯æ›´åƒäº†ï¼Ÿ

å‰æ–‡ [æ‰‹æŠŠæ‰‹åˆ·äºŒå‰æ ‘ï¼ˆçº²é¢†ç¯‡ï¼‰](https://labuladong.github.io/algo/2/21/36/) è¯´äºŒå‰æ ‘é—®é¢˜å¯ä»¥åˆ†ä¸ºä¸¤ç±»æ€è·¯ï¼Œä¸€ç±»æ˜¯éå†ä¸€éäºŒå‰æ ‘çš„æ€è·¯ï¼Œå¦ä¸€ç±»æ˜¯åˆ†è§£é—®é¢˜çš„æ€è·¯ï¼Œæ ¹æ®ä¸Šè¿°ç±»æ¯”ï¼Œæ˜¾ç„¶å½’å¹¶æ’åºåˆ©ç”¨çš„æ˜¯åˆ†è§£é—®é¢˜çš„æ€è·¯ï¼ˆ [åˆ†æ²»ç®—æ³•](https://labuladong.github.io/algo/4/33/122/)ï¼‰ã€‚

**å½’å¹¶æ’åºçš„è¿‡ç¨‹å¯ä»¥åœ¨é€»è¾‘ä¸ŠæŠ½è±¡æˆä¸€æ£µäºŒå‰æ ‘ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹çš„å€¼å¯ä»¥è®¤ä¸ºæ˜¯ `nums[lo..hi]`ï¼Œå¶å­èŠ‚ç‚¹çš„å€¼å°±æ˜¯æ•°ç»„ä¸­çš„å•ä¸ªå…ƒç´ **ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/1.jpeg)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/1.jpeg)

ç„¶åï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹çš„ååºä½ç½®ï¼ˆå·¦å³å­èŠ‚ç‚¹å·²ç»è¢«æ’å¥½åºï¼‰çš„æ—¶å€™æ‰§è¡Œ `merge` å‡½æ•°ï¼Œåˆå¹¶ä¸¤ä¸ªå­èŠ‚ç‚¹ä¸Šçš„å­æ•°ç»„ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/2.jpeg)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/2.jpeg)

è¿™ä¸ª `merge` æ“ä½œä¼šåœ¨äºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æ‰§è¡Œä¸€éï¼Œæ‰§è¡Œé¡ºåºæ˜¯äºŒå‰æ ‘ååºéå†çš„é¡ºåºã€‚

ååºéå†äºŒå‰æ ‘å¤§å®¶åº”è¯¥å·²ç»çƒ‚ç†Ÿäºå¿ƒäº†ï¼Œå°±æ˜¯ä¸‹å›¾è¿™ä¸ªéå†é¡ºåºï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/3.jpeg)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/3.jpeg)

ç»“åˆä¸Šè¿°åŸºæœ¬åˆ†æï¼Œæˆ‘ä»¬æŠŠ `nums[lo..hi]` ç†è§£æˆäºŒå‰æ ‘çš„èŠ‚ç‚¹ï¼Œ`sort` å‡½æ•°ç†è§£æˆäºŒå‰æ ‘çš„éå†å‡½æ•°ï¼Œæ•´ä¸ªå½’å¹¶æ’åºçš„æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯ä»¥ä¸‹ GIF æè¿°çš„è¿™æ ·ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/4.gif)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/4.gif)

è¿™æ ·ï¼Œå½’å¹¶æ’åºçš„æ ¸å¿ƒæ€è·¯å°±åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥åªè¦æŠŠæ€è·¯ç¿»è¯‘æˆä»£ç å°±è¡Œã€‚

### ä»£ç å®ç°åŠåˆ†æ

**åªè¦æ‹¥æœ‰äº†æ­£ç¡®çš„æ€ç»´æ–¹å¼ï¼Œç†è§£ç®—æ³•æ€è·¯æ˜¯ä¸å›°éš¾çš„ï¼Œä½†æŠŠæ€è·¯å®ç°æˆä»£ç ï¼Œä¹Ÿå¾ˆè€ƒéªŒä¸€ä¸ªäººçš„ç¼–ç¨‹èƒ½åŠ›**ã€‚

æ¯•ç«Ÿç®—æ³•çš„æ—¶é—´å¤æ‚åº¦åªæ˜¯ä¸€ä¸ªç†è®ºä¸Šçš„è¡¡é‡æ ‡å‡†ï¼Œè€Œç®—æ³•çš„å®é™…è¿è¡Œæ•ˆç‡è¦è€ƒè™‘çš„å› ç´ æ›´å¤šï¼Œæ¯”å¦‚åº”è¯¥é¿å…å†…å­˜çš„é¢‘ç¹åˆ†é…é‡Šæ”¾ï¼Œä»£ç é€»è¾‘åº”å°½å¯èƒ½ç®€æ´ç­‰ç­‰ã€‚

ç»è¿‡å¯¹æ¯”ï¼Œã€Šç®—æ³• 4ã€‹ä¸­ç»™å‡ºçš„å½’å¹¶æ’åºä»£ç å…¼å…·äº†ç®€æ´å’Œé«˜æ•ˆçš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å‚è€ƒä¹¦ä¸­ç»™å‡ºçš„ä»£ç ä½œä¸ºå½’å¹¶ç®—æ³•æ¨¡æ¿ï¼š

```java
class Merge {

    // ç”¨äºè¾…åŠ©åˆå¹¶æœ‰åºæ•°ç»„
    private static int[] temp;

    public static void sort(int[] nums) {
        // å…ˆç»™è¾…åŠ©æ•°ç»„å¼€è¾Ÿå†…å­˜ç©ºé—´
        temp = new int[nums.length];
        // æ’åºæ•´ä¸ªæ•°ç»„ï¼ˆåŸåœ°ä¿®æ”¹ï¼‰
        sort(nums, 0, nums.length - 1);
    }

    // å®šä¹‰ï¼šå°†å­æ•°ç»„ nums[lo..hi] è¿›è¡Œæ’åº
    private static void sort(int[] nums, int lo, int hi) {
        if (lo == hi) {
            // å•ä¸ªå…ƒç´ ä¸ç”¨æ’åº
            return;
        }
        // è¿™æ ·å†™æ˜¯ä¸ºäº†é˜²æ­¢æº¢å‡ºï¼Œæ•ˆæœç­‰åŒäº (hi + lo) / 2
        int mid = lo + (hi - lo) / 2;
        // å…ˆå¯¹å·¦åŠéƒ¨åˆ†æ•°ç»„ nums[lo..mid] æ’åº
        sort(nums, lo, mid);
        // å†å¯¹å³åŠéƒ¨åˆ†æ•°ç»„ nums[mid+1..hi] æ’åº
        sort(nums, mid + 1, hi);
        // å°†ä¸¤éƒ¨åˆ†æœ‰åºæ•°ç»„åˆå¹¶æˆä¸€ä¸ªæœ‰åºæ•°ç»„
        merge(nums, lo, mid, hi);
    }

    // å°† nums[lo..mid] å’Œ nums[mid+1..hi] è¿™ä¸¤ä¸ªæœ‰åºæ•°ç»„åˆå¹¶æˆä¸€ä¸ªæœ‰åºæ•°ç»„
    private static void merge(int[] nums, int lo, int mid, int hi) {
        // å…ˆæŠŠ nums[lo..hi] å¤åˆ¶åˆ°è¾…åŠ©æ•°ç»„ä¸­
        // ä»¥ä¾¿åˆå¹¶åçš„ç»“æœèƒ½å¤Ÿç›´æ¥å­˜å…¥ nums
        for (int i = lo; i <= hi; i++) {
            temp[i] = nums[i];
        }

        // æ•°ç»„åŒæŒ‡é’ˆæŠ€å·§ï¼Œåˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„
        int i = lo, j = mid + 1;
        for (int p = lo; p <= hi; p++) {
            if (i == mid + 1) {
                // å·¦åŠè¾¹æ•°ç»„å·²å…¨éƒ¨è¢«åˆå¹¶
                nums[p] = temp[j++];
            } else if (j == hi + 1) {
                // å³åŠè¾¹æ•°ç»„å·²å…¨éƒ¨è¢«åˆå¹¶
                nums[p] = temp[i++];
            } else if (temp[i] > temp[j]) {
                nums[p] = temp[j++];
            } else {
                nums[p] = temp[i++];
            }
        }
    }
}
```

æœ‰äº†ä¹‹å‰çš„é“ºå«ï¼Œè¿™é‡Œåªéœ€è¦ç€é‡è®²ä¸€ä¸‹è¿™ä¸ª `merge` å‡½æ•°ã€‚

`sort` å‡½æ•°å¯¹ `nums[lo..mid]` å’Œ `nums[mid+1..hi]` é€’å½’æ’åºå®Œæˆä¹‹åï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•åŸåœ°æŠŠå®ƒä¿©åˆå¹¶ï¼Œæ‰€ä»¥éœ€è¦ copy åˆ° `temp` æ•°ç»„é‡Œé¢ï¼Œç„¶åé€šè¿‡ç±»ä¼¼äºå‰æ–‡ [å•é“¾è¡¨çš„å…­å¤§æŠ€å·§](https://labuladong.github.io/algo/2/19/18/) ä¸­åˆå¹¶æœ‰åºé“¾è¡¨çš„åŒæŒ‡é’ˆæŠ€å·§å°† `nums[lo..hi]` åˆå¹¶æˆä¸€ä¸ªæœ‰åºæ•°ç»„ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/5.jpeg)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/5.jpeg)

æ³¨æ„æˆ‘ä»¬ä¸æ˜¯åœ¨ `merge` å‡½æ•°æ‰§è¡Œçš„æ—¶å€™ new è¾…åŠ©æ•°ç»„ï¼Œè€Œæ˜¯æå‰æŠŠ `temp` è¾…åŠ©æ•°ç»„ new å‡ºæ¥äº†ï¼Œè¿™æ ·å°±é¿å…äº†åœ¨é€’å½’ä¸­é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾å†…å­˜å¯èƒ½äº§ç”Ÿçš„æ€§èƒ½é—®é¢˜ã€‚

å†è¯´ä¸€ä¸‹å½’å¹¶æ’åºçš„æ—¶é—´å¤æ‚åº¦ï¼Œè™½ç„¶å¤§ä¼™å„¿åº”è¯¥éƒ½çŸ¥é“æ˜¯ `O(NlogN)`ï¼Œä½†ä¸è§å¾—æ‰€æœ‰äººéƒ½çŸ¥é“è¿™ä¸ªå¤æ‚åº¦æ€ä¹ˆç®—å‡ºæ¥çš„ã€‚

å‰æ–‡ [åŠ¨æ€è§„åˆ’è¯¦è§£](https://labuladong.github.io/algo/3/25/69/) è¯´è¿‡é€’å½’ç®—æ³•çš„å¤æ‚åº¦è®¡ç®—ï¼Œå°±æ˜¯å­é—®é¢˜ä¸ªæ•° x è§£å†³ä¸€ä¸ªå­é—®é¢˜çš„å¤æ‚åº¦ã€‚å¯¹äºå½’å¹¶æ’åºæ¥è¯´ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¾ç„¶é›†ä¸­åœ¨ `merge` å‡½æ•°éå† `nums[lo..hi]` çš„è¿‡ç¨‹ï¼Œä½†æ¯æ¬¡ `merge` è¾“å…¥çš„ `lo` å’Œ `hi` éƒ½ä¸åŒï¼Œæ‰€ä»¥ä¸å®¹æ˜“ç›´è§‚åœ°çœ‹å‡ºæ—¶é—´å¤æ‚åº¦ã€‚

`merge` å‡½æ•°åˆ°åº•æ‰§è¡Œäº†å¤šå°‘æ¬¡ï¼Ÿæ¯æ¬¡æ‰§è¡Œçš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿæ€»çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿè¿™å°±è¦ç»“åˆä¹‹å‰ç”»çš„è¿™å¹…å›¾æ¥çœ‹ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/1.jpeg)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/1.jpeg)

**æ‰§è¡Œçš„æ¬¡æ•°æ˜¯äºŒå‰æ ‘èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œæ¯æ¬¡æ‰§è¡Œçš„å¤æ‚åº¦å°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨çš„å­æ•°ç»„çš„é•¿åº¦ï¼Œæ‰€ä»¥æ€»çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯æ•´æ£µæ ‘ä¸­ã€Œæ•°ç»„å…ƒç´ ã€çš„ä¸ªæ•°**ã€‚

æ‰€ä»¥ä»æ•´ä½“ä¸Šçœ‹ï¼Œè¿™ä¸ªäºŒå‰æ ‘çš„é«˜åº¦æ˜¯ `logN`ï¼Œå…¶ä¸­æ¯ä¸€å±‚çš„å…ƒç´ ä¸ªæ•°å°±æ˜¯åŸæ•°ç»„çš„é•¿åº¦ `N`ï¼Œæ‰€ä»¥æ€»çš„æ—¶é—´å¤æ‚åº¦å°±æ˜¯ `O(NlogN)`ã€‚

åŠ›æ‰£ç¬¬ 912 é¢˜ã€Œ [æ’åºæ•°ç»„](https://leetcode.cn/problems/sort-an-array/)ã€å°±æ˜¯è®©ä½ å¯¹æ•°ç»„è¿›è¡Œæ’åºï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¥—ç”¨å½’å¹¶æ’åºä»£ç æ¨¡æ¿ï¼š

```java
class Solution {
    public int[] sortArray(int[] nums) {
        // å½’å¹¶æ’åºå¯¹æ•°ç»„è¿›è¡ŒåŸåœ°æ’åº
        Merge.sort(nums);
        return nums;
    }
}

class Merge {
    // è§ä¸Šæ–‡
}
```

### å…¶ä»–åº”ç”¨

é™¤äº†æœ€åŸºæœ¬çš„æ’åºé—®é¢˜ï¼Œå½’å¹¶æ’åºè¿˜å¯ä»¥ç”¨æ¥è§£å†³åŠ›æ‰£ç¬¬ 315 é¢˜ã€Œ [è®¡ç®—å³ä¾§å°äºå½“å‰å…ƒç´ çš„ä¸ªæ•°](https://leetcode.cn/problems/count-of-smaller-numbers-after-self/)ã€ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/title1.png)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/title1.png)

æˆ‘ç”¨æ¯”è¾ƒæ•°å­¦çš„è¯­è¨€æ¥æè¿°ä¸€ä¸‹ï¼ˆæ–¹ä¾¿å’Œåç»­ç±»ä¼¼é¢˜ç›®è¿›è¡Œå¯¹æ¯”ï¼‰ï¼Œé¢˜ç›®è®©ä½ æ±‚å‡ºä¸€ä¸ª `count` æ•°ç»„ï¼Œä½¿å¾—ï¼š

```sql
count[i] = COUNT(j) where j > i and nums[j] < nums[i]
```

æ‹è„‘è¢‹çš„æš´åŠ›è§£æ³•å°±ä¸è¯´äº†ï¼ŒåµŒå¥— for å¾ªç¯ï¼Œå¹³æ–¹çº§åˆ«çš„å¤æ‚åº¦ã€‚

è¿™é¢˜å’Œå½’å¹¶æ’åºä»€ä¹ˆå…³ç³»å‘¢ï¼Œä¸»è¦åœ¨ `merge` å‡½æ•°ï¼Œ**æˆ‘ä»¬åœ¨ä½¿ç”¨ `merge` å‡½æ•°åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„çš„æ—¶å€™ï¼Œå…¶å®æ˜¯å¯ä»¥çŸ¥é“ä¸€ä¸ªå…ƒç´  `nums[i]` åè¾¹æœ‰å¤šå°‘ä¸ªå…ƒç´ æ¯” `nums[i]` å°çš„**ã€‚

å…·ä½“æ¥è¯´ï¼Œæ¯”å¦‚è¿™ä¸ªåœºæ™¯ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/6.jpeg)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/6.jpeg)

è¿™æ—¶å€™æˆ‘ä»¬åº”è¯¥æŠŠ `temp[i]` æ”¾åˆ° `nums[p]` ä¸Šï¼Œå› ä¸º `temp[i] < temp[j]`ã€‚

ä½†å°±åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çŸ¥é“ä¸€ä¸ªä¿¡æ¯ï¼š5 åé¢æ¯” 5 å°çš„å…ƒç´ ä¸ªæ•°å°±æ˜¯ å·¦é—­å³å¼€åŒºé—´ `[mid + 1, j)` ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå³ 2 å’Œ 4 è¿™ä¸¤ä¸ªå…ƒç´ ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/7.jpeg)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/7.jpeg)

**æ¢å¥è¯è¯´ï¼Œåœ¨å¯¹ `nums[lo..hi]` åˆå¹¶çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å½“æ‰§è¡Œ `nums[p] = temp[i]` æ—¶ï¼Œå°±å¯ä»¥ç¡®å®š `temp[i]` è¿™ä¸ªå…ƒç´ åé¢æ¯”å®ƒå°çš„å…ƒç´ ä¸ªæ•°ä¸º `j - mid - 1`**ã€‚

å½“ç„¶ï¼Œ`nums[lo..hi]` æœ¬èº«ä¹Ÿåªæ˜¯ä¸€ä¸ªå­æ•°ç»„ï¼Œè¿™ä¸ªå­æ•°ç»„ä¹‹åè¿˜ä¼šè¢«æ‰§è¡Œ `merge`ï¼Œå…¶ä¸­å…ƒç´ çš„ä½ç½®è¿˜æ˜¯ä¼šæ”¹å˜ã€‚ä½†è¿™æ˜¯å…¶ä»–é€’å½’èŠ‚ç‚¹éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œæˆ‘ä»¬åªè¦åœ¨ `merge` å‡½æ•°ä¸­åšä¸€äº›æ‰‹è„šï¼Œå åŠ æ¯æ¬¡ `merge` æ—¶è®°å½•çš„ç»“æœå³å¯ã€‚

å‘ç°äº†è¿™ä¸ªè§„å¾‹åï¼Œæˆ‘ä»¬åªè¦åœ¨ `merge` ä¸­æ·»åŠ ä¸¤è¡Œä»£ç å³å¯è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œçœ‹è§£æ³•ä»£ç ï¼š

```java
class Solution {
    private class Pair {
        int val, id;
        Pair(int val, int id) {
            // è®°å½•æ•°ç»„çš„å…ƒç´ å€¼
            this.val = val;
            // è®°å½•å…ƒç´ åœ¨æ•°ç»„ä¸­çš„åŸå§‹ç´¢å¼•
            this.id = id;
        }
    }
    
    // å½’å¹¶æ’åºæ‰€ç”¨çš„è¾…åŠ©æ•°ç»„
    private Pair[] temp;
    // è®°å½•æ¯ä¸ªå…ƒç´ åé¢æ¯”è‡ªå·±å°çš„å…ƒç´ ä¸ªæ•°
    private int[] count;
    
    // ä¸»å‡½æ•°
    public List<Integer> countSmaller(int[] nums) {
        int n = nums.length;
        count = new int[n];
        temp = new Pair[n];
        Pair[] arr = new Pair[n];
        // è®°å½•å…ƒç´ åŸå§‹çš„ç´¢å¼•ä½ç½®ï¼Œä»¥ä¾¿åœ¨ count æ•°ç»„ä¸­æ›´æ–°ç»“æœ
        for (int i = 0; i < n; i++)
            arr[i] = new Pair(nums[i], i);
        
        // æ‰§è¡Œå½’å¹¶æ’åºï¼Œæœ¬é¢˜ç»“æœè¢«è®°å½•åœ¨ count æ•°ç»„ä¸­
        sort(arr, 0, n - 1);
        
        List<Integer> res = new LinkedList<>();
        for (int c : count) res.add(c);
        return res;
    }
    
    // å½’å¹¶æ’åº
    private void sort(Pair[] arr, int lo, int hi) {
        if (lo == hi) return;
        int mid = lo + (hi - lo) / 2;
        sort(arr, lo, mid);
        sort(arr, mid + 1, hi);
        merge(arr, lo, mid, hi);
    }
    
    // åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„
    private void merge(Pair[] arr, int lo, int mid, int hi) {
        for (int i = lo; i <= hi; i++) {
            temp[i] = arr[i];
        }
        
        int i = lo, j = mid + 1;
        for (int p = lo; p <= hi; p++) {
            if (i == mid + 1) {
                arr[p] = temp[j++];
            } else if (j == hi + 1) {
                arr[p] = temp[i++];
                // æ›´æ–° count æ•°ç»„
                count[arr[p].id] += j - mid - 1;
            } else if (temp[i].val > temp[j].val) {
                arr[p] = temp[j++];
            } else {
                arr[p] = temp[i++];
                // æ›´æ–° count æ•°ç»„
                count[arr[p].id] += j - mid - 1;
            }
        }
    }
}
```

å› ä¸ºåœ¨æ’åºè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªå…ƒç´ çš„ç´¢å¼•ä½ç½®ä¼šä¸æ–­æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ä¸€ä¸ª `Pair` ç±»å°è£…æ¯ä¸ªå…ƒç´ åŠå…¶åœ¨åŸå§‹æ•°ç»„ `nums` ä¸­çš„ç´¢å¼•ï¼Œä»¥ä¾¿ `count` æ•°ç»„è®°å½•æ¯ä¸ªå…ƒç´ ä¹‹åå°äºå®ƒçš„å…ƒç´ ä¸ªæ•°ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹å‡ é“åŸç†ç±»ä¼¼çš„é¢˜ç›®ï¼Œéƒ½æ˜¯é€šè¿‡ç»™å½’å¹¶æ’åºçš„ `merge` å‡½æ•°åŠ ä¸€äº›ç§è´§å®Œæˆç›®æ ‡ã€‚

çœ‹ä¸€ä¸‹åŠ›æ‰£ç¬¬ 493 é¢˜ã€Œ [ç¿»è½¬å¯¹](https://leetcode.cn/problems/reverse-pairs/)ã€ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/title2.png)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/title2.png)

æˆ‘æŠŠè¿™é“é¢˜æ¢ä¸ªè¡¨è¿°æ–¹å¼ï¼Œä½ æ³¨æ„å’Œä¸Šä¸€é“é¢˜ç›®å¯¹æ¯”ï¼š

è¯·ä½ å…ˆæ±‚å‡ºä¸€ä¸ª `count` æ•°ç»„ï¼Œå…¶ä¸­ï¼š

```sql
count[i] = COUNT(j) where j > i and nums[i] > 2*nums[j]
```

ç„¶åè¯·ä½ æ±‚å‡ºè¿™ä¸ª `count` æ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ çš„å’Œã€‚

ä½ çœ‹ï¼Œè¿™æ ·è¯´å…¶å®å’Œé¢˜ç›®æ˜¯ä¸€ä¸ªæ„æ€ï¼Œè€Œä¸”å’Œä¸Šä¸€é“é¢˜éå¸¸ç±»ä¼¼ï¼Œåªä¸è¿‡ä¸Šä¸€é¢˜æ±‚çš„æ˜¯ `nums[i] > nums[j]`ï¼Œè¿™é‡Œæ±‚çš„æ˜¯ `nums[i] > 2*nums[j]` ç½¢äº†ã€‚

æ‰€ä»¥è§£é¢˜çš„æ€è·¯å½“ç„¶è¿˜æ˜¯è¦åœ¨ `merge` å‡½æ•°ä¸­åšç‚¹æ‰‹è„šï¼Œå½“ `nums[lo..mid]` å’Œ `nums[mid+1..hi]` ä¸¤ä¸ªå­æ•°ç»„å®Œæˆæ’åºåï¼Œå¯¹äº `nums[lo..mid]` ä¸­çš„æ¯ä¸ªå…ƒç´  `nums[i]`ï¼Œå» `nums[mid+1..hi]` ä¸­å¯»æ‰¾ç¬¦åˆæ¡ä»¶çš„ `nums[j]` å°±è¡Œäº†ã€‚

çœ‹ä¸€ä¸‹æˆ‘ä»¬å¯¹ `merge` å‡½æ•°çš„æ”¹é€ ï¼š

```java
// è®°å½•ã€Œç¿»è½¬å¯¹ã€çš„ä¸ªæ•°
int count = 0;

// å°† nums[lo..mid] å’Œ nums[mid+1..hi] è¿™ä¸¤ä¸ªæœ‰åºæ•°ç»„åˆå¹¶æˆä¸€ä¸ªæœ‰åºæ•°ç»„
private void merge(int[] nums, int lo, int mid, int hi) {
    for (int i = lo; i <= hi; i++) {
        temp[i] = nums[i];
    }
    
    // åœ¨åˆå¹¶æœ‰åºæ•°ç»„ä¹‹å‰ï¼ŒåŠ ç‚¹ç§è´§
    for (int i = lo; i <= mid; i++) {
        // å¯¹äºå·¦åŠè¾¹çš„æ¯ä¸ª nums[i]ï¼Œéƒ½å»å³åŠè¾¹å¯»æ‰¾ç¬¦åˆæ¡ä»¶çš„å…ƒç´ 
        for (int j = mid + 1; j <= hi; j++) {
            // nums ä¸­çš„å…ƒç´ å¯èƒ½è¾ƒå¤§ï¼Œä¹˜ 2 å¯èƒ½æº¢å‡ºï¼Œæ‰€ä»¥è½¬åŒ–æˆ long
            if ((long)nums[i] > (long)nums[j] * 2) {
                count++;
            }
        }
    }
    
    // æ•°ç»„åŒæŒ‡é’ˆæŠ€å·§ï¼Œåˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„
    int i = lo, j = mid + 1;
    for (int p = lo; p <= hi; p++) {
        if (i == mid + 1) {
            nums[p] = temp[j++];
        } else if (j == hi + 1) {
            nums[p] = temp[i++];
        } else if (temp[i] > temp[j]) {
            nums[p] = temp[j++];
        } else {
            nums[p] = temp[i++];
        }
    }
}
```

ä¸è¿‡å‘¢ï¼Œè¿™æ®µä»£ç æäº¤ä¼šè¶…æ—¶ï¼Œæ¯•ç«Ÿé¢å¤–æ·»åŠ äº†ä¸€ä¸ªåµŒå¥— for å¾ªç¯ã€‚æ€ä¹ˆè¿›è¡Œä¼˜åŒ–å‘¢ï¼Œæ³¨æ„å­æ•°ç»„ `nums[lo..mid]` æ˜¯æ’å¥½åºçš„ï¼Œä¹Ÿå°±æ˜¯ `nums[i] <= nums[i+1]`ã€‚

æ‰€ä»¥ï¼Œå¯¹äº `nums[i], lo <= i <= mid`ï¼Œæˆ‘ä»¬åœ¨æ‰¾åˆ°çš„ç¬¦åˆ `nums[i] > 2*nums[j]` çš„ `nums[j], mid+1 <= j <= hi`ï¼Œä¹Ÿå¿…ç„¶ä¹Ÿç¬¦åˆ `nums[i+1] > 2*nums[j]`ã€‚

**æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬ä¸ç”¨æ¯æ¬¡éƒ½å‚»ä¹ä¹åœ°å»éå†æ•´ä¸ª `nums[mid+1..hi]`ï¼Œåªè¦ç»´æŠ¤ä¸€ä¸ªå¼€åŒºé—´è¾¹ç•Œ `end`ï¼Œç»´æŠ¤ `nums[mid+1..end-1]` æ˜¯ç¬¦åˆæ¡ä»¶çš„å…ƒç´ å³å¯**ã€‚

çœ‹æœ€ç»ˆçš„è§£æ³•ä»£ç ï¼š

```java
public int reversePairs(int[] nums) {
    // æ‰§è¡Œå½’å¹¶æ’åº
    sort(nums);
    return count;
}

private int[] temp;

public void sort(int[] nums) {
    temp = new int[nums.length];
    sort(nums, 0, nums.length - 1);
}

// å½’å¹¶æ’åº
private void sort(int[] nums, int lo, int hi) {
    if (lo == hi) {
        return;
    }
    int mid = lo + (hi - lo) / 2;
    sort(nums, lo, mid);
    sort(nums, mid + 1, hi);
    merge(nums, lo, mid, hi);
}

// è®°å½•ã€Œç¿»è½¬å¯¹ã€çš„ä¸ªæ•°
private int count = 0;

private void merge(int[] nums, int lo, int mid, int hi) {
    for (int i = lo; i <= hi; i++) {
        temp[i] = nums[i];
    }
    
    // è¿›è¡Œæ•ˆç‡ä¼˜åŒ–ï¼Œç»´æŠ¤å·¦é—­å³å¼€åŒºé—´ [mid+1, end) ä¸­çš„å…ƒç´ ä¹˜ 2 å°äº nums[i]
    // ä¸ºä»€ä¹ˆ end æ˜¯å¼€åŒºé—´ï¼Ÿå› ä¸ºè¿™æ ·çš„è¯å¯ä»¥ä¿è¯åˆå§‹åŒºé—´ [mid+1, mid+1) æ˜¯ä¸€ä¸ªç©ºåŒºé—´
    int end = mid + 1;
    for (int i = lo; i <= mid; i++) {
        // nums ä¸­çš„å…ƒç´ å¯èƒ½è¾ƒå¤§ï¼Œä¹˜ 2 å¯èƒ½æº¢å‡ºï¼Œæ‰€ä»¥è½¬åŒ–æˆ long
        while (end <= hi && (long)nums[i] > (long)nums[end] * 2) {
            end++;
        }
        count += end - (mid + 1);
    }

    // æ•°ç»„åŒæŒ‡é’ˆæŠ€å·§ï¼Œåˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„
    int i = lo, j = mid + 1;
    for (int p = lo; p <= hi; p++) {
        if (i == mid + 1) {
            nums[p] = temp[j++];
        } else if (j == hi + 1) {
            nums[p] = temp[i++];
        } else if (temp[i] > temp[j]) {
            nums[p] = temp[j++];
        } else {
            nums[p] = temp[i++];
        }
    }
}
```

å¦‚æœä½ èƒ½å¤Ÿç†è§£è¿™é“é¢˜ç›®ï¼Œæˆ‘ä»¬æœ€åæ¥çœ‹ä¸€é“éš¾åº¦æ›´å¤§çš„é¢˜ç›®ï¼ŒåŠ›æ‰£ç¬¬ 327 é¢˜ã€Œ [åŒºé—´å’Œçš„ä¸ªæ•°](https://leetcode.cn/problems/count-of-range-sum/)ã€ï¼š

[![img](https://labuladong.github.io/algo/images/%e5%bd%92%e5%b9%b6%e6%8e%92%e5%ba%8f/title3.png)](https://labuladong.github.io/algo/images/å½’å¹¶æ’åº/title3.png)

ç®€å•è¯´ï¼Œé¢˜ç›®è®©ä½ è®¡ç®—å…ƒç´ å’Œè½åœ¨ `[lower, upper]` ä¸­çš„æ‰€æœ‰å­æ•°ç»„çš„ä¸ªæ•°ã€‚

æ‹è„‘è¢‹çš„æš´åŠ›è§£æ³•æˆ‘å°±ä¸è¯´äº†ï¼Œä¾ç„¶æ˜¯åµŒå¥— for å¾ªç¯ï¼Œè¿™é‡Œè¿˜æ˜¯è¯´åˆ©ç”¨å½’å¹¶æ’åºå®ç°çš„é«˜æ•ˆç®—æ³•ã€‚

é¦–å…ˆï¼Œè§£å†³è¿™é“é¢˜éœ€è¦å¿«é€Ÿè®¡ç®—å­æ•°ç»„çš„å’Œï¼Œæ‰€ä»¥ä½ éœ€è¦é˜…è¯»å‰æ–‡ [å‰ç¼€å’Œæ•°ç»„æŠ€å·§](https://labuladong.github.io/algo/2/20/24/)ï¼Œåˆ›å»ºä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„ `preSum` æ¥è¾…åŠ©æˆ‘ä»¬è¿…é€Ÿè®¡ç®—åŒºé—´å’Œã€‚

æˆ‘ç»§ç»­ç”¨æ¯”è¾ƒæ•°å­¦çš„è¯­è¨€æ¥è¡¨è¿°ä¸‹è¿™é“é¢˜ï¼Œé¢˜ç›®è®©ä½ é€šè¿‡ `preSum` æ•°ç»„æ±‚ä¸€ä¸ª `count` æ•°ç»„ï¼Œä½¿å¾—ï¼š

```sql
count[i] = COUNT(j) where lower <= preSum[j] - preSum[i] <= upper
```

ç„¶åè¯·ä½ æ±‚å‡ºè¿™ä¸ª `count` æ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ çš„å’Œã€‚

ä½ çœ‹ï¼Œè¿™æ˜¯ä¸æ˜¯å’Œé¢˜ç›®æè¿°ä¸€æ ·ï¼Ÿ`preSum` ä¸­çš„ä¸¤ä¸ªå…ƒç´ ä¹‹å·®å…¶å®å°±æ˜¯åŒºé—´å’Œã€‚

æœ‰äº†ä¹‹å‰ä¸¤é“é¢˜çš„é“ºå«ï¼Œæˆ‘ç›´æ¥ç»™å‡ºè¿™é“é¢˜çš„è§£æ³•ä»£ç å§ï¼Œæ€è·¯è§æ³¨é‡Šï¼š

```java
private int lower, upper;

public int countRangeSum(int[] nums, int lower, int upper) {
this.lower = lower;
    this.upper = upper;
    // æ„å»ºå‰ç¼€å’Œæ•°ç»„ï¼Œæ³¨æ„ int å¯èƒ½æº¢å‡ºï¼Œç”¨ long å­˜å‚¨
    long[] preSum = new long[nums.length + 1];
    for (int i = 0; i < nums.length; i++) {
        preSum[i + 1] = (long)nums[i] + preSum[i];
    }
    // å¯¹å‰ç¼€å’Œæ•°ç»„è¿›è¡Œå½’å¹¶æ’åº
    sort(preSum);
    return count;
}

private long[] temp;

public void sort(long[] nums) {
    temp = new long[nums.length];
    sort(nums, 0, nums.length - 1);
}

private void sort(long[] nums, int lo, int hi) {
    if (lo == hi) {
        return;
    }
    int mid = lo + (hi - lo) / 2;
    sort(nums, lo, mid);
    sort(nums, mid + 1, hi);
    merge(nums, lo, mid, hi);
}

private int count = 0;

private void merge(long[] nums, int lo, int mid, int hi) {
    for (int i = lo; i <= hi; i++) {
        temp[i] = nums[i];
    }
    
    // åœ¨åˆå¹¶æœ‰åºæ•°ç»„ä¹‹å‰åŠ ç‚¹ç§è´§ï¼ˆè¿™æ®µä»£ç ä¼šè¶…æ—¶ï¼‰
    // for (int i = lo; i <= mid; i++) {
    //     for (int j = mid + 1; j <= hi; k++) {
    //         // å¯»æ‰¾ç¬¦åˆæ¡ä»¶çš„ nums[j]
    //         long delta = nums[j] - nums[i];
    //         if (delta <= upper && delta >= lower) {
    //             count++;
    //         }
    //     }
    // }
    
    // è¿›è¡Œæ•ˆç‡ä¼˜åŒ–
    // ç»´æŠ¤å·¦é—­å³å¼€åŒºé—´ [start, end) ä¸­çš„å…ƒç´ å’Œ nums[i] çš„å·®åœ¨ [lower, upper] ä¸­
    int start = mid + 1, end = mid + 1;
    for (int i = lo; i <= mid; i++) {
        // å¦‚æœ nums[i] å¯¹åº”çš„åŒºé—´æ˜¯ [start, end)ï¼Œ
        // é‚£ä¹ˆ nums[i+1] å¯¹åº”çš„åŒºé—´ä¸€å®šä¼šæ•´ä½“å³ç§»ï¼Œç±»ä¼¼æ»‘åŠ¨çª—å£
        while (start <= hi && nums[start] - nums[i] < lower) {
            start++;
        }
        while (end <= hi && nums[end] - nums[i] <= upper) {
            end++;
        }
        count += end - start;
    }

    // æ•°ç»„åŒæŒ‡é’ˆæŠ€å·§ï¼Œåˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„
    int i = lo, j = mid + 1;
    for (int p = lo; p <= hi; p++) {
        if (i == mid + 1) {
            nums[p] = temp[j++];
        } else if (j == hi + 1) {
            nums[p] = temp[i++];
        } else if (temp[i] > temp[j]) {
            nums[p] = temp[j++];
        } else {
            nums[p] = temp[i++];
        }
    }
}
```

æˆ‘ä»¬ä¾ç„¶åœ¨ `merge` å‡½æ•°åˆå¹¶æœ‰åºæ•°ç»„ä¹‹å‰åŠ äº†ä¸€äº›é€»è¾‘ï¼Œå¦‚æœçœ‹è¿‡å‰æ–‡ [æ»‘åŠ¨çª—å£æ ¸å¿ƒæ¡†æ¶](https://labuladong.github.io/algo/2/20/27/)ï¼Œè¿™ä¸ªæ•ˆç‡ä¼˜åŒ–æœ‰ç‚¹ç±»ä¼¼ç»´æŠ¤ä¸€ä¸ªæ»‘åŠ¨çª—å£ï¼Œè®©çª—å£ä¸­çš„å…ƒç´ å’Œ `nums[i]` çš„å·®è½åœ¨ `[lower, upper]` ä¸­ã€‚

å½’å¹¶æ’åºç›¸å…³çš„é¢˜ç›®åˆ°è¿™é‡Œå°±è®²å®Œäº†ï¼Œä½ ç°åœ¨å›å¤´ä½“ä¼šä¸‹æˆ‘åœ¨æœ¬æ–‡å¼€å¤´è¯´é‚£å¥è¯ï¼š

**æ‰€æœ‰é€’å½’çš„ç®—æ³•ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨éå†ä¸€æ£µï¼ˆé€’å½’ï¼‰æ ‘ï¼Œç„¶ååœ¨èŠ‚ç‚¹ï¼ˆå‰ä¸­ååºä½ç½®ï¼‰ä¸Šæ‰§è¡Œä»£ç ã€‚ä½ è¦å†™é€’å½’ç®—æ³•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è¦å‘Šè¯‰æ¯ä¸ªèŠ‚ç‚¹éœ€è¦åšä»€ä¹ˆ**ã€‚

æ¯”å¦‚æœ¬æ–‡è®²çš„å½’å¹¶æ’åºç®—æ³•ï¼Œé€’å½’çš„ `sort` å‡½æ•°å°±æ˜¯äºŒå‰æ ‘çš„éå†å‡½æ•°ï¼Œè€Œ `merge` å‡½æ•°å°±æ˜¯åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåšçš„äº‹æƒ…ï¼Œæœ‰æ²¡æœ‰å“å‡ºç‚¹å‘³é“ï¼Ÿ

æœ€åæ€»ç»“ä¸€ä¸‹å§ï¼Œæœ¬æ–‡ä»äºŒå‰æ ‘çš„è§’åº¦è®²äº†å½’å¹¶æ’åºçš„æ ¸å¿ƒæ€è·¯å’Œä»£ç å®ç°ï¼ŒåŒæ—¶è®²äº†å‡ é“å½’å¹¶æ’åºç›¸å…³çš„ç®—æ³•é¢˜ã€‚è¿™äº›ç®—æ³•é¢˜å…¶å®å°±æ˜¯å½’å¹¶æ’åºç®—æ³•é€»è¾‘ä¸­å¤¹æ‚ä¸€ç‚¹ç§è´§ï¼Œä½†ä»ç„¶å±äºæ¯”è¾ƒéš¾çš„ï¼Œä½ å¯èƒ½éœ€è¦äº²è‡ªåšä¸€éæ‰èƒ½ç†è§£ã€‚

é‚£æˆ‘æœ€åç•™ä¸€ä¸ªæ€è€ƒé¢˜å§ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« æˆ‘ä¼šè®²å¿«é€Ÿæ’åºï¼Œä½ æ˜¯å¦èƒ½å¤Ÿå°è¯•ç€ä»äºŒå‰æ ‘çš„è§’åº¦å»ç†è§£å¿«é€Ÿæ’åºï¼Ÿå¦‚æœè®©ä½ ç”¨ä¸€å¥è¯æ€»ç»“å¿«é€Ÿæ’åºçš„é€»è¾‘ï¼Œä½ æ€ä¹ˆæè¿°ï¼Ÿ

å¥½äº†ï¼Œç­”æ¡ˆåœ¨ä¸‹ç¯‡æ–‡ç«  [å¿«é€Ÿæ’åºè¯¦è§£åŠåº”ç”¨](https://labuladong.github.io/algo/2/21/45/) æ­æ™“ã€‚